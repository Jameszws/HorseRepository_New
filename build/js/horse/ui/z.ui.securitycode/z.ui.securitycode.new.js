define(["text!virtualKeyTempl","virtualKey"],function(VirtualKeyTempl,virtualKey){var securityCodePlugIn=function(){this.defaultParams={containerId:"",securityCodePlugInAreaId:"",fillInCompleteCallBack:null,needConfirmPassword:{referencePasswordId:"",callback:null},isNeedClickSCShowVirtualKey:!1,clickSCCallback:null,isHasFixedPosition:!1,fixedPositionAreaId:"",virtualkeyClickCallback:null}};return securityCodePlugIn.prototype={constructor:securityCodePlugIn,init:function(i){this.options=Horse.util.coverObject(this.defaultParams,i),this._init()},_init:function(){this.renderTempl()},pwdStyle:{spanLeft:"0px"},renderTempl:function(){var containerId=this.options.containerId,securityCodePlugInAreaId=this.options.securityCodePlugInAreaId,virtualKeyContainerId=securityCodePlugInAreaId+"_virtualKey",totalWidth=$("#"+containerId).css("width");this.pwdStyle.spanLeft=parseInt(totalWidth)/12-5+"px";var temp="";if(temp+="<div class='secutitycodeArea' id='"+securityCodePlugInAreaId+"'>",temp+="\t<div class='secutitycodeBg'>",temp+="\t\t<div class='item' sc='1'></div>",temp+="\t\t<div class='item' sc='2'></div>",temp+="\t\t<div class='item' sc='3'></div>",temp+="\t\t<div class='item' sc='4'></div>",temp+="\t\t<div class='item' sc='5'></div>",temp+="\t\t<div class='item' sc='6'></div>",temp+="\t\t<input type='password' style='display: none' />",temp+="\t</div>",temp+="\t<div class='virtualKeyContainer' id="+virtualKeyContainerId+"></div>",temp+="</div>",$("#"+containerId).html(temp),$("#"+securityCodePlugInAreaId).css("width",totalWidth),this.getElements(),!this.options.isNeedClickSCShowVirtualKey)return void(this.options.isHasFixedPosition?(virtualKeyContainerId=this.options.fixedPositionAreaId,this.isPopVirtualKeyShowFlase_isHasFixedPositionTrue(virtualKeyContainerId)):($("#"+virtualKeyContainerId).show(),this.isPopVirtualKeyShow_Flase(virtualKeyContainerId)));var t=this;eval('var events = {"click #'+securityCodePlugInAreaId+'>div.secutitycodeBg": "click_secutitycode"};');for(var e in events){var typeTarget=e.split(" ");if(typeTarget&&2==typeTarget.length){var type=typeTarget[0],target=typeTarget[1];$("#"+containerId).find(target).on(type,$.proxy(t[events[e]],this))}}this.click_document()},click_document:function(){var i=this;$(document).bind("click",function(t){if(0==$(t.target).closest("#"+i.options.securityCodePlugInAreaId+",#"+i.options.referencePasswordId+",#"+i.options.fixedPositionAreaId).length)return void $("#"+i.options.fixedPositionAreaId).hide()})},isPopVirtualKeyShow_Flase:function(i){var t=$("#"+this.options.containerId).css("width"),e=parseInt(t)+2+"px";this.virtualKeyInit(i,e,!1)},isPopVirtualKeyShowFlase_isHasFixedPositionTrue:function(i){this.virtualKeyInit(i,"100%",!1)},virtualKeyInit:function(i,t,e){var s=this;(new virtualKey).init({containerId:i,showWidth:t,isPopShow:e,virtualkeyClickCallback:function(i){s.virtualkeyClickCallbackHandler(i)}})},click_secutitycode:function(){if(Horse.validate.isFunction(this.options.clickSCCallback)&&this.options.clickSCCallback(),this.options.isHasFixedPosition)return void this.click_secutitycode_isHasFixedPositionTrue();this.click_secutitycode_isHasFixedPositionFlase()},click_secutitycode_isHasFixedPositionTrue:function(){$("#"+this.options.fixedPositionAreaId).html(""),this.virtualKeyInit(this.options.fixedPositionAreaId,"100%",!1)},click_secutitycode_isHasFixedPositionFlase:function(){var i=$("#"+this.options.containerId).css("width"),t=.8*parseInt(i)+"px";this.virtualKeyInit("",t,!0)},virtualkeyClickCallbackHandler:function(i){var t=$("#"+this.options.securityCodePlugInAreaId+">div.secutitycodeBg>input[type=password]"),e=this;if("delete"!=i)return e.SecurityCodeContent.each(function(s,n){return 0!=$(n).find("span").length||($(n).html("<span style='left:"+e.pwdStyle.spanLeft+"'></span>"),t.val(t.val()+i),6==t.val().trim().length&&(e.fillInCompleteCallBackHandler(t.val()),e.needConfirmPasswordHandler(t.val())),!1)}),Horse.validate.isFunction(this.options.virtualkeyClickCallback)&&this.options.virtualkeyClickCallback(),!0;var s=new Array(6);e.SecurityCodeContent.each(function(i,t){s[5-i]=t});for(var n=0;n<6;n++){var o=$(s[n]);if(1==$(o).find("span").length){$(o).html("");var a=t.val();t.val(a.substring(0,a.length-1)),5==t.val().trim().length&&(e.fillInCompleteCallBackHandler(t.val()),e.needConfirmPasswordHandler(t.val()));break}}Horse.validate.isFunction(this.options.virtualkeyClickCallback)&&this.options.virtualkeyClickCallback()},fillInCompleteCallBackHandler:function(i){Horse.validate.isFunction(this.options.fillInCompleteCallBack)&&6==i.length&&this.options.fillInCompleteCallBack(i)},needConfirmPasswordHandler:function(i){if(!Horse.validate.isNull(this.options.needConfirmPassword.referencePasswordId)){var t=$("#"+this.options.needConfirmPassword.referencePasswordId+">div.secutitycodeBg>input[type=password]"),e=t.val().trim();if(6==e.length&&6==i.length&&e==i)return void(Horse.validate.isFunction(this.options.needConfirmPassword.callback)&&this.options.needConfirmPassword.callback(!0,e));Horse.validate.isFunction(this.options.needConfirmPassword.callback)&&this.options.needConfirmPassword.callback(!1)}},getElements:function(){var i=this.options.securityCodePlugInAreaId;this.SecurityCodeContent=$("#"+i).find("div[class=secutitycodeBg]>div")}},securityCodePlugIn});